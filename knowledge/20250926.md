# プロジェクト要約（次回キャッチアップ用）

## 目的
- **飲食店の「騒音／静けさ」主観評価**（食べログの口コミ断片）と、**客観的に関連しうる店内要因**（天井高・ホール面積・家具密度など）を結びつけ、学習用データセットを構築する。
- **画像は中間生成物**：実体ファイルは保持せず、URLから解析→特徴量のみ保存。

---

## データソース
- 食べログ 検索結果（東京）：  
  - 騒がしい系キーワード：`騒がしい｜うるさい｜賑やか｜にぎやか`  
  - 落ち着き系キーワード：`落ち着いた｜落ち着き｜静か｜静かな｜しっとり`
- 各店舗ページ → **内観写真一覧** `.../dtlphotolst/3/(smp2/)` とページネーション。

---

## 現在のCSV（例）
- `tabelog_noise_tokyo_p2_p20_v15.csv` … リストページ集約（v1.5）
  - 列: `店名, 星数, rvw_count, calm_flg, loud_flg, コメント, genre, 昼予算, 夜予算, お店URL`
- `tabelog_interior_photo_urls_with_meta_stream.csv` … 店舗ごとの**内観写真URL**（ストリーム追記）
  - 列: `店名, 星数, rvw_count, calm_flg, loud_flg, 昼予算, 夜予算, お店URL, photo_page_url, img_thumb_url, img_full_url, alt, caption`
- （以降）画像特徴量CSV（PoC解析で作成予定）
  - 列（案）: `store_id, n_images, location_type, est_hall_area, est_hall_height, furniture_index, ...`

---

## スクリプト一覧と役割

### 1) リストスクレイパー（口コミ断片＋メタ）
**`noise_scraper_v1_5.py`**（ユーザ提示スクリプト名）
- 追加実装:
  - `rvw_count`（口コミ人数）
  - `昼予算` / `夜予算`（`￥4,000～...` → `4000`）
  - `genre` 抽出（例: `居酒屋、寿司、海鮮`）
  - calm/loud スニペット検出＆ `calm_flg` `loud_flg` フラグ
  - **ページネーション**：基準URLに `/2/ .. /N/` を付与（パラメタ）
- 既知の注意:
  - **カフェ検索URL**ではDOM差異があり、スニペット／ジャンルが取りにくいケースあり →（後述）v1.5’相当のセレクタ強化が必要。

### 2) 内観写真URL収集（存在リンクのみ辿る）
**`tabelog_interior_photo_urls_v1_2_stream.py`**（アップロード済）
- ポイント:
  - 候補: `.../dtlphotolst/3/smp2/` → `.../3/` → `.../smp2/` → `.../dtlphotolst/` の順で探す
  - **ページ内の実在 `<a ...PG=>` だけ**を収集（404回避）
  - **1行ずつ追記保存**（ストリーム）。`--resume` で既出店舗URLをスキップ可能。
  - 相対URLは `urljoin` で絶対化。重複除去あり。
- 出力列: 上述のメタ＋画像URL列


3) URLバッチ画像解析（画像は保存せずbytesで解析）

poc_image_to_noise_urlbatch.py（ユーザ環境で実行）

主な処理:

img_full_url を HTTP 取得 → MiDaS（単眼Depth）＋YOLOv8（家具・人）で解析

furniture_index（面積・件数・人の占有を合成、γ補正）

天井高・床面積の簡易推定（消失点フック＋床マスク＋深度正規化）

重複フレーム番号の去重（_{NNN}.jpg）

既知の修正（反映済）:

robust_mean の型Union表記（Py3.10互換）

マスクとDepthのサイズ不一致 → cv.resize で合わせてからインデクス

4) レビューアスペクト分析（ストリーム希望）

review_aspect_sentiment_v1.py（アップロード済）

口コミ断片を騒音・静けさ関連のアスペクトに正規化して保存（行ごと追記）する流れを想定。

直近の問題/対応

?PG=2 が存在しないページ → v1.2系で実リンクのみ巡回に変更（404回避）

写真ページDOM差（カフェなど） → extract_thumbs を緩め、img[data-xxx|src] と alt/caption の取りこぼしを減らす

Depth/Mask 形状不一致 → cv.resize で揃える修正

型ヒントの互換性（Py3.10） → Optional[float] に統一

大量データ時のメモリ → ストリーム書き出し（URL収集・レビュー分析とも）

列仕様（確定）

リストCSV（v1.5）:
店名, 星数, rvw_count, calm_flg, loud_flg, コメント, genre, 昼予算, 夜予算, お店URL

内観写真URLCSV（stream）:
店名, 星数, rvw_count, calm_flg, loud_flg, 昼予算, 夜予算, お店URL, photo_page_url, img_thumb_url, img_full_url, alt, caption

画像特徴量CSV（PoC出力）（案）:
store_id, n_images, location_type, est_hall_area, est_hall_height, furniture_index, min, ave, max, ...

運用 Tips

東京限定: お店URL が https://tabelog.com/tokyo/ で始まるもののみ採用

予算抽出: ￥4,000～￥4,999 → 4000（- は空値）

スニペット検出: list-keyword-hit（兄弟）→ list-rst__comment-wrap（店ブロック内）を順に探索

画像は保存しない：bytesで解析→特徴量のみ保存（ToS配慮）

リクエスト間隔: ランダムスリープ（礼儀＋ブロック回避）

次アクション（提案）

カフェ系URL向けに noise_scraper_v1_5.py のセレクタをもう一段緩和（DOM差対応版 v1.5’を作成）

tabelog_interior_photo_urls_v1_2_stream.py を全店に走らせ、URL収集を完了

poc_image_to_noise_urlbatch.py を 最大8枚/店 程度で一度回し、特徴量の統計を点検

口コミ断片 → 正規化アスペクト（例: 「個室」「天井」「席間」「BGM」など）へ写像する辞書を拡張

ラベル（y）整備：既存の min/ave/max dB（テキスト）取り込みスキーム確認/整合

実行例:

**実行例**
```bash
python tabelog_interior_photo_urls_v1_2_stream.py \
  --input tabelog_noise_tokyo_p2_p20_v15.csv \
  --output tabelog_interior_photo_urls_with_meta_stream.csv \
  --max_pages 5 \
  --resume
python poc_image_to_noise_urlbatch.py \
  --photo_csv tabelog_interior_photo_urls_with_meta_stream.csv \
  --out features_from_urls.csv \
  --max_photos 8 \
  --y_base ./src/data/restaurant
# 1) リスト集約（例）
python noise_scraper_v1_5.py \
  "NOISY_URL" "CALM_URL" \
  tabelog_noise_tokyo_p2_p20_v15.csv 2 60

# 2) 内観写真URL（ストリーム）
python tabelog_interior_photo_urls_v1_2_stream.py \
  --input tabelog_noise_tokyo_p2_p20_v15.csv \
  --output tabelog_interior_photo_urls_with_meta_stream.csv \
  --max_pages 5 \
  --resume

# 3) 画像PoC解析（URL→特徴量）
python poc_image_to_noise_urlbatch.py \
  --photo_csv tabelog_interior_photo_urls_with_meta_stream.csv \
  --out features_from_urls.csv \
  --max_photos 8 \
  --y_base ./src/data/restaurant
