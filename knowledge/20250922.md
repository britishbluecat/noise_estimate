# 🎵 Noise Estimation PoC 開発ナレッジ

このドキュメントは、ChatGPT とのやり取りを整理した **開発ナレッジ** です。  
店舗画像から騒音推定データセットを生成する PoC (`poc_image_to_noise.py`) の改善・実装の履歴を記録しています。

---

## ✅ 開発の目的

- 店舗（カフェ/ラーメン店など）の **画像** と **騒音測定値（min/ave/max）** から特徴量を作成し、学習用データセットを生成する。  
- 出力する CSV には以下を含む：
  - `store_id`
  - `n_images`
  - `location_type`
  - `est_hall_area`
  - `est_hall_height`
  - `furniture_index`
  - `min`, `ave`, `max`

---

## 📂 データ構造

```plaintext
src/data/
├── cafe/
│   ├── aaa.txt        # dB値 (CSV形式: min,ave,max)
│   ├── aaa_001.jpg    # 店舗写真
│   ├── aaa_002.png
│   └── ...
├── ramen/
│   ├── bbb.txt
│   ├── bbb_001.jpg
│   └── ...
└── other/
    └── ...
```

*.txt: 騒音測定値
```plaintext
min,ave,max
56,64,79
```

*_NNN.jpg|png: 店舗画像（複数枚）

##⚙️ 依存ライブラリ
```plaintext
pip install opencv-python numpy pandas torch torchvision ultralytics scikit-image matplotlib timm
```
MiDaS (torch.hub: intel-isl/MiDaS)
YOLOv8 (ultralytics)

##🚀 実行方法
```plaintext
cd src
python poc_image_to_noise.py --base "./data" --out output_dataset.csv
```
📊 出力例
| store_id | n_images | location_type | est_hall_area | est_hall_height | furniture_index | min | ave | max |
|----------|----------|---------------|---------------|-----------------|-----------------|-----|-----|-----|
| aaa      | 5        | cafe          | 10.0          | 2.8             | 5.7             | 56  | 64  | 79  |

##🧩 実装の工夫点

1. 画像解析

MiDaS による単眼深度推定

消失点近似 による室内構造推定

YOLOv8 による椅子・机・人物検出 → 家具密度 index

床マスク推定 による相対面積補正

2. スケール合わせ

A4メニューなど、既知寸法でスケール調整可能

無い場合は高さの事前分布 (2.6〜3.0m) を使用

3. 集約

複数画像から堅牢平均（median + MAD 重み付け）

家具密度 index を 0〜8 にクリップ

出力 CSV に n_images を追加（解析に使用した画像枚数）🛠️ 修正履歴（このチャットで実施）

 base 未定義エラー → main関数内で解決

 OpenCV バージョン差異対応 (createLineSegmentDetector) → safe_create_lsd() を実装

 furniture_index が常に 10 → γ補正, 個数飽和, 上限8に修正

 出力CSVに n_images を追加

 CSV列順序を変更 → store_id, n_images を先頭に

##📌 今後の改良ポイント

SfM (Structure from Motion) による複数画像の3D統合

部屋全体の容積推定

録音波形特徴量（RT60, 周波数帯ノイズ）との統合

Web UI による簡易アップロード&解析

家具密度の平均化・異常値除去

# 🖥️ Noise Data Entry GUI

このGUIは、店舗内の音響推定PoCで利用するデータ (`src/data/`) を簡単に入力・管理するためのツールです。  
カフェなどでノートPCを使い、短時間でデータ収集＋入力をデモできることを目的としています。

---

## 🎯 機能概要

- **2つのタブ構成**
  - **メイン**: 新規データ入力フォーム
  - **データ**: 既存CSV (`output_dataset.csv`) の先頭5行をプレビュー

- **サポートする操作**
  - カテゴリ選択 / 新規カテゴリ作成
  - 店舗ID入力
  - 画像選択（最大 5 or 10 枚）
  - 騒音レベル (min/ave/max) 入力
  - 保存 / リセット / Undo
  - 既存データをCSVからプレビュー表示

---

## 📂 データ構造

```plaintext
src/data/
├── cafe/
│   ├── aaa.txt         # dB値 (CSV形式: min,ave,max)
│   ├── aaa_001.jpg     # 店舗写真
│   ├── aaa_002.png
│   └── ...
├── ramen/
│   ├── bbb.txt
│   ├── bbb_001.jpg
│   └── ...
└── other/
    └── ...
```

## 🖼️ GUI仕様
「メイン」タブ
項目	内容
カテゴリ	既存フォルダを選択 or 「新規カテゴリ」ボタンで新規作成
店舗ID	店舗を一意に識別するID
最大画像枚数	5 / 10 を選択。選択枚数以下の画像ファイルを利用
画像選択	ファイルダイアログからjpg/pngを選択
dB値	min / ave / max を手入力
保存	指定フォルダに .txt と画像をコピー保存
リセット	入力内容をクリア
Undo	直前の保存操作を取り消し（txtと画像削除）

## データ」タブ

output_dataset.csv の内容を Treeviewテーブル に表示

先頭5行をプレビュー

列幅100px、中央寄せ

## 📊 出力フォーマット (output_dataset.csv)

| store_id | n_images | location_type | est_hall_area | est_hall_height | furniture_index | min | ave | max |
|----------|----------|---------------|---------------|-----------------|-----------------|-----|-----|-----|
| aaa      | 5        | cafe          | 10.0          | 2.8             | 5.7             | 56  |     |     |


## ⚡ 実行方法

```plaintext
cd src
python gui_data_entry.py
```

---

##💡 この形式なら、  
- **GitHub の README.md にそのまま貼れる**  
- 1つの Markdown コードブロックにまとめ済み  
- 表やツリーも正しくレンダリング  

にできます。  
